var segments = {
    "1128428288": "_`klEludnUhJsB",
        "1115593730": "mtilEnrdnUxJdAjAVlAd@_@dAy@dDu@|Du@nBwCpGyA`Cy@bAaFlE",
        "1277683849": "umklEj~fnU|@c@fBuA`AeADSvF{JrAuDv@}DPmC@eDAU",
        "1081467916": "_|ilE|mcnUfF~@hBj@~BbAdAn@~@v@p@nAV|AEp@RFHK?QW[",
        "1327282319": "czjlEfuenUoH`@kCMuF}@",
        "1200561302": "utjlExqdnUEQ",
        "1088582426": "ybklEdqfnUo@lA",
        "1304598047": "{`klE~tdnUlEf]H~@",
        "1164656166": "eoklEvtenURgBHoBI[",
        "1146649131": "sxilEbbcnU@WwDOaEJgCXeDr@yBt@wUtKnF|a@",
      "1276880433": "qnklEbmenUAgBEgAC[k@_E",
        "1108376370": "idklErsfnUuA`CeBjByA`A_@Ng@yBk@oAoAkBoAgAgBoAsB_D`FyF~@wAfAkCx@sDD[",
        "1324900788": "utjlExqdnU|Cq@xBUjAExELhEd@",
        "1276032954": "_|ilE|mcnUFeADQlAkDNuB",
        "1245201851": "ipklEv`enU@]o@}B",
        "1102197181": "eoklEvtenUvF`AxBD`Ia@",
        "1247750334": "czjlEfuenU@bCOhD]vBEf@W`Ae@vAgAlCUVgAnB",
        "1089270593": "wqklEz{dnUvDmBnI}A",
       "1076993352": "_`klEludnUoFwa@`UsKzBy@rFaAbEQpDHr@D",
        "1245313098": "mtilEnrdnUaCA}Bm@",
        "1094789196": "czilEd}enUnD}CfC}CzB}DrB_F\\eAzAkH`AmCsBw@gCYqHi@",
        "1306398548": "{`klE~tdnUSN",
        "1161871713": "m|ilE~pdnUq@YcFq@eD?uCX{Dx@",
        "1185825379": "msklEr_fnU??",
        "1261340901": "qnklEbmenUKPMtCIp@",
        "1247870185": "qyjlE|uenUdJM~CHjFl@lBf@h@Zv@v@`@n@",
        "1140669546": "mzilEr|enUHP",
        "1142412781": "wqklEz{dnUUJr@~BNN",
       "1316796989": "czilEd}enU^zALjBGnAq@|ECvBLlC|@fFZhEb@|BdA|CT|BDnEn@vGGhB[bBq@pAkAfA_Bl@u@LIJcDHqBAy@GyDiAgAEiBZ]qBc@{@oAiAcEiCy@}@m@sAQs@]wEa@yCw@_CcAmAm@]QUoBgAk@{@YeA",
        "1172810867": "{tjlEfqdnUe@aC{AmCi@aBI]Gu@EcADkAf@oCd@gAdAmANMpC}AzAs@xBo@bHm@|ABjAJ",
        "1285825513": "qyjlE|uenU?q@Gi@_@mDeDeW",
        "1157309049": "uoklE|senUOfAQz@w@jC]x@y@tAk@x@uEfFlB`Dz@x@pBtAbAfAp@tA\\t@n@pCRK",
        "1098251130": "oaklEnudnUXDTG",
        "1227675882": "{tjlEfqdnU_KvB"
  };



var routes = { //All the route info from transloc (parsed into object with route_id as key and route details as value)
    
	
	
	
	
	

 "8006640":          {
                "description": "",
                "short_name": "H",
                "route_id": "8006640",
                "color": "F0659E",
                          "segments": [
                    [
                        "1081467916",
                        "backward"
                    ],
                    [
                        "1102197181",
                        "forward"
                    ],
                    [
                        "1108376370",
                        "forward"
                    ],
                    [
                        "1128428288",
                        "forward"
                    ],
         
                    [
                        "1172810867",
                        "forward"
                    ],
              
                    [
                        "1247750334",
                        "forward"
                    ],
              
                    [
                        "1304598047",
                        "forward"
                    ]
                ],
                "is_active": true,
                "agency_id": 1039,
                "text_color": "000000",
                "long_name": "Line",
                "url": "",
                "is_hidden": false,
                "type": "bus",
                "stops": [
                    "8197566",
                    "8197554",
                    "8197568",
                    "8197572",
                    "8197574",
                    "8197576",
                    "8197558",
                    "8197560",
                    "8197580",
                    "8197582",
                    "8197584",
					"8197564",
					"8197578"
                ]
            }
};
























var stopIDs = { //All stop info from transloc (parsed into object with stop_id as key and stop info as value)
 "8197554":   {
            "code": "101",
            "description": "",
            "url": "",
            "parent_station_id": null,
            "agency_ids": [
                "1039"
            ],
            "station_id": null,
            "location_type": "stop",
            "location": {
                "lat": 33.6482742539,
                "lng": -117.832373636
            },
            "stop_id": "8197554",
            "routes": [
                "8006640"
            ],
            "name": "Campus - Cornell"
        },
 "8197558":       {
            "code": "103",
            "description": "",
            "url": "",
            "parent_station_id": null,
            "agency_ids": [
                "1039"
            ],
            "station_id": null,
            "location_type": "stop",
            "location": {
                "lat": 33.640122,
                "lng": -117.825105
            },
            "stop_id": "8197558",
            "routes": [
                "8006640"
            ],
            "name": "631 VDC Stop #1"
        },
   "8197560":     {
            "code": "104",
            "description": "",
            "url": "",
            "parent_station_id": null,
            "agency_ids": [
                "1039"
            ],
            "station_id": null,
            "location_type": "stop",
            "location": {
                "lat": 33.64156801,
                "lng": -117.8242376
            },
            "stop_id": "8197560",
            "routes": [
                "8006640"
            ],
            "name": "621 VDC Stop #2"
        },
 "8197564":       {
            "code": "106",
            "description": "",
            "url": "",
            "parent_station_id": null,
            "agency_ids": [
                "1039"
            ],
            "station_id": null,
            "location_type": "stop",
            "location": {
                "lat": 33.647182,
                "lng": -117.829486
            },
            "stop_id": "8197564",
            "routes": [
                "8006640"
            ],
            "name": "Plaza Verde Housing"
        },
 "8197566":       {
            "code": "107",
            "description": "",
            "url": "",
            "parent_station_id": null,
            "agency_ids": [
                "1039"
            ],
            "station_id": null,
            "location_type": "stop",
            "location": {
                "lat": 33.649279,
                "lng": -117.839683
            },
            "stop_id": "8197566",
            "routes": [
                "8006640"
            ],
            "name": "University Center, North"
        },
 "8197568":       {
            "code": "108",
            "description": "",
            "url": "",
            "parent_station_id": null,
            "agency_ids": [
                "1039"
            ],
            "station_id": null,
            "location_type": "stop",
            "location": {
                "lat": 33.648182,
                "lng": -117.829985
            },
            "stop_id": "8197568",
            "routes": [
                "8006640"
            ],
            "name": "California - Campus"
        },
"8197572":        {
            "code": "110",
            "description": "",
            "url": "",
            "parent_station_id": null,
            "agency_ids": [
                "1039"
            ],
            "station_id": null,
            "location_type": "stop",
            "location": {
                "lat": 33.646195,
                "lng": -117.824399
            },
            "stop_id": "8197572",
            "routes": [
                "8006640"
            ],
            "name": "CDS Stop #1"
        },
"8197574":        {
            "code": "111",
            "description": "",
            "url": "",
            "parent_station_id": null,
            "agency_ids": [
                "1039"
            ],
            "station_id": null,
            "location_type": "stop",
            "location": {
                "lat": 33.645191,
                "lng": -117.823979
            },
            "stop_id": "8197574",
            "routes": [
                "8006640"
            ],
            "name": "CDS Stop #2"
        },
"8197576":       {
            "code": "112",
            "description": "",
            "url": "",
            "parent_station_id": null,
            "agency_ids": [
                "1039"
            ],
            "station_id": null,
            "location_type": "stop",
            "location": {
                "lat": 33.643649,
                "lng": -117.823805
            },
            "stop_id": "8197576",
            "routes": [
                "8006640"
            ],
            "name": "CDS Stop #3"
        },
 "8197578":       {
            "code": "113",
            "description": "",
            "url": "",
            "parent_station_id": null,
            "agency_ids": [
                "1039"
            ],
            "station_id": null,
            "location_type": "stop",
            "location": {
                "lat": 33.6484431906,
                "lng": -117.83277828
            },
            "stop_id": "8197578",
            "routes": [
                "8006640"
            ],
            "name": "Puerta del Sol, North"
        },
 "8197580":       {
            "code": "118",
            "description": "",
            "url": "",
            "parent_station_id": null,
            "agency_ids": [
                "1039"
            ],
            "station_id": null,
            "location_type": "stop",
            "location": {
                "lat": 33.643378,
                "lng": -117.823724
            },
            "stop_id": "8197580",
            "routes": [
                "8006640"
            ],
            "name": "VDC Norte Stop #1"
        },
 "8197582":       {
            "code": "124",
            "description": "",
            "url": "",
            "parent_station_id": null,
            "agency_ids": [
                "1039"
            ],
            "station_id": null,
            "location_type": "stop",
            "location": {
                "lat": 33.645823,
                "lng": -117.824088
            },
            "stop_id": "8197582",
            "routes": [
                "8006640"
            ],
            "name": "VDC Norte Stop #2"
        },
 "8197584":       {
            "code": "125",
            "description": "",
            "url": "",
            "parent_station_id": null,
            "agency_ids": [
                "1039"
            ],
            "station_id": null,
            "location_type": "stop",
            "location": {
                "lat": 33.647596,
                "lng": -117.825392
            },
            "stop_id": "8197584",
            "routes": [
                "8006640"
            ],
            "name": "VDC Norte Stop #3"
        },
 "8197580":       {
            "code": "118",
            "description": "",
            "url": "",
            "parent_station_id": null,
            "agency_ids": [
                "1039"
            ],
            "station_id": null,
            "location_type": "stop",
            "location": {
                "lat": 33.643378,
                "lng": -117.823724
            },
            "stop_id": "8197580",
            "routes": [
                "8006640"
            ],
            "name": "VDC Norte Stop #1"
        }

       
  
};

//List of route_ids for regular routes vs summer routes
//Used when switching between the two views on the frontend
var academicRoutes = ['8006640'];
var summerRoutes = ['8004754'];


//Generates Object with each segment_id as a key and the list of routes that segment is a part of as the value
var allSegments = {};
for (var segment in segments) {
    allSegments[segment] = [];
}
for (var route in routes) {
    for (var i = 0; i < routes[route].segments.length; i++) {
        if (allSegments[routes[route].segments[i][0]].indexOf(route) === -1 &&  route != '8004754') {
            allSegments[routes[route].segments[i][0]].push(route);
        }
    }
}

//Utility Function to grab the parameters of the URL
function getParameterByName(name, url) {
    if (!url) url = window.location.href;
    name = name.replace(/[\[\]]/g, "\\$&");
    var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
        results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, " "));
}

//Main Document.ready function
var VanillaRunOnDomReady = function () {

    var singleRoute = false; //Checks whether to display all routes or a list of routes

    //Ensures that var loadRoute is an array of route_ids
    if (typeof loadRoute !== 'undefined' && loadRoute !== null && loadRoute !== '') {
        if (!Array.isArray(loadRoute)) {
            loadRoute = [loadRoute];
        }
        singleRoute = true;
    }

    console.log(loadRoute);

    //Sets up the main google map object
    var map = new google.maps.Map(document.getElementById('map-canvas'), {
        clickableIcons: false,
        styles: [{
            featureType: 'poi',
            elementType: 'labels',
            stylers: [{"saturation": -100}, {"lightness": 25}]
        }]
    });

    var markers = {}; //Vehicle Markers
    var stopMarkers = {};

    var lines = []; //The lines drawn for the bus routes

    var estimateStops = {}; //Stores the estimated arrival times
    var urlRoute; //Not really used atm

    var inServiceRoutes = []; //List of route_ids of routes in service

    // Sets up the content for the info windows when clicking a stop
    var iwContent = "<div id='iw-container'><div class='iw-title'><span class='iw-stop-title'></span><br /><span class='iw-title-sub'>Arrival Estimates</span></div><div class='iw-content'><div class='iw-in-service-title'>In Service</div><div class='iw-in-service'></div><div class='iw-not-in-service-title'>Not In Service</div><div class='iw-not-in-service'></div></div></div>";
    var $c = $(iwContent);

    for (var route in routes) {
        $('.ae-status').find('.line-' + route).css({'border-left': '8px solid #' + routes[route].color});
        $('.ae-status-container').find('.line-' + route).find('.not-in-service').show();
        $c.find('.iw-in-service').append("<div class='iw-route iw-route-" + route + "' style='display: none; border-left: 8px solid #" + routes[route].color + "'>" + routes[route].short_name + " " + routes[route].long_name + ": <span class='iw-estimate'></span></div>");
        $c.find('.iw-not-in-service').append("<div class='iw-route iw-route-" + route + "' style='display: none; border-left: 8px solid #" + routes[route].color + "'>" + routes[route].short_name + " " + routes[route].long_name + "</div>");
    }

    iwContent = $c[0].outerHTML;

    //One single info window is used for every stop and it is updated with the correct window location and content
    var infoWindow = new google.maps.InfoWindow({
        content: iwContent,
        maxWidth: 350
    });

    //Handles switching between Academic Year view and Summer View
    $('.ae-status-academic-button').on('click', function () {
        singleRoute = true;
        loadRoute = academicRoutes;
        for (var marker in markers) {
            markers[marker].setMap(null);
        }
        markers = {};

        for (var stopMarker in stopMarkers) {
            stopMarkers[stopMarker].setMap(null);
        }
        stopMarkers = {};

        for (var i = 0; i < lines.length; i++) {
            lines[i].setMap(null);
        }
        lines = [];
        $('.ae-status-summer').hide();
        $('.ae-status-summer-button').removeClass('ae-status-active');
        $('.ae-status-academic').show();
        $('.ae-status-academic-button').addClass('ae-status-active');
        initialize();
    });

    //Handles switching between Academic Year view and Summer View
    $('.ae-status-summer-button').on('click', function () {
        singleRoute = true;
        loadRoute = summerRoutes;
        for (var marker in markers) {
            markers[marker].setMap(null);
        }
        markers = {};

        for (var stopMarker in stopMarkers) {
            stopMarkers[stopMarker].setMap(null);
        }
        stopMarkers = {};

        for (var i = 0; i < lines.length; i++) {
            lines[i].setMap(null);
        }
        lines = [];
        $('.ae-status-summer').show();
        $('.ae-status-summer-button').addClass('ae-status-active');
        $('.ae-status-academic').hide();
        $('.ae-status-academic-button').removeClass('ae-status-active');
        initialize();
    });

    //Contains all the drawing of route lines and placing of stop markers
    function initialize() {

        urlRoute = getParameterByName('route');

        //route_ids with the bounds of the routes for initial map position
        var routeExtremes = {
            "default": {
                "lat_min": 33.6374936,
                "lat_max": 33.6737154,
                "lng_max": -117.8224099,
                "lng_min": -117.8532412
            },
			
		
           "8005906": {"lat_min": 33.63968, "lat_max": 33.65341, "lng_max": -117.82375, "lng_min": -117.84186},
		   "8006640": {"lat_min": 33.64248, "lat_max": 33.65371, "lng_max": -117.82187, "lng_min": -117.84176},
		   "8004738": {"lat_min": 33.64248, "lat_max": 33.65341, "lng_max": -117.82175, "lng_min": -117.84176},
		   "8005894": {"lat_min": 33.64248, "lat_max": 33.65371, "lng_max": -117.82187, "lng_min": -117.84176},
             "8006482": {"lat_min": 33.63915, "lat_max": 33.65104, "lng_max": -117.82187, "lng_min": -117.84923},
          
            "8006438": {"lat_min": 33.63968, "lat_max": 33.65341, "lng_max": -117.82375, "lng_min": -117.84176}
           
        };

        var lat_min = routeExtremes["default"].lat_min;
        var lat_max = routeExtremes["default"].lat_max;
        var lng_max = routeExtremes["default"].lng_max;
        var lng_min = routeExtremes["default"].lng_min;

        if (singleRoute && loadRoute.length === 1) {
            lat_min = routeExtremes[loadRoute[0]].lat_min;
            lat_max = routeExtremes[loadRoute[0]].lat_max;
            lng_max = routeExtremes[loadRoute[0]].lng_max;
            lng_min = routeExtremes[loadRoute[0]].lng_min;
        }

        map.setCenter(new google.maps.LatLng(
            ((lat_max + lat_min) / 2.0),
            ((lng_max + lng_min) / 2.0)
        ));
        map.fitBounds(new google.maps.LatLngBounds(
            //bottom left
            new google.maps.LatLng(lat_min, lng_min),
            //top right
            new google.maps.LatLng(lat_max, lng_max)
        ));

        //Ensures the info window closes when user clicks away from the window
        google.maps.event.addListener(map, "click", function (event) {
            infoWindow.close();
        });

        //Info Window customization/styling
        google.maps.event.addListener(infoWindow, 'domready', function () {

            // Reference to the DIV that wraps the bottom of infowindow
            var iwOuter = $('.gm-style-iw');

            /* Since this div is in a position prior to .gm-div style-iw.
             * We use jQuery and create a iwBackground variable,
             * and took advantage of the existing reference .gm-style-iw for the previous div with .prev().
             */
            var iwBackground = iwOuter.prev();

            // Removes background shadow DIV
            iwBackground.children(':nth-child(2)').css({'display': 'none'});

            // Removes white background DIV
            iwBackground.children(':nth-child(4)').css({'display': 'none'});

            // Moves the infowindow 115px to the right.
            iwOuter.parent().parent().css({left: '90px'});

		setTimeout(function(){ //Necessary because the arrow gets moved by default later in the stack somewhere? Never could find it
			// Moves the shadow of the arrow 76px to the left margin.
            iwBackground.children(':nth-child(1)').attr('style', function (i, s) {
                return s + 'left: 76px !important;'
            });

            // Moves the arrow 76px to the left margin.
            iwBackground.children(':nth-child(3)').attr('style', function (i, s) {
                return s + 'left: 76px !important;'
            });
		}, 100)
            

            // Changes the desired tail shadow color.
            iwBackground.children(':nth-child(3)').find('div').children().css({
                'box-shadow': 'rgba(72, 181, 233, 0.6) 0px 1px 6px',
                'z-index': '1'
            });

            // Reference to the div that groups the close button elements.
            var iwCloseBtn = iwOuter.next();

            // Apply the desired effect to the close button
            iwCloseBtn.css({
                opacity: '1',
                right: '38px',
                top: '3px',
                border: '7px solid #48b5e9',
                'border-radius': '13px',
                'box-shadow': '0 0 5px #3990B9'
            });

            // If the content of infowindow not exceed the set maximum height, then the gradient is removed.
            if ($('.iw-content').height() < 140) {
                $('.iw-bottom-gradient').css({display: 'none'});
            }

            // The API automatically applies 0.7 opacity to the button after the mouseout event. This function reverses this event to the desired value.
            iwCloseBtn.mouseout(function () {
                $(this).css({opacity: '1'});
            });
        });

        //Draws the regular route segments
        for (var route in routes) {
            if (singleRoute && loadRoute.indexOf(route) === -1) {
                continue;
            }
            for (var i = 0; i < routes[route].segments.length; i++) {
                var d = routes[route].segments[i][0];
                var decode = google.maps.geometry.encoding.decodePath(segments[d]);
                var line = new google.maps.Polyline({
                    path: decode,
                    strokeColor: '#' + routes[route].color,
                    strokeOpacity: 1.0,
                    strokeWeight: 4,
                    zIndex: 3,
                    clickable: false
                });

                lines.push(line);

                line.setMap(map);
            }
        }

        //Overlapping route segments
        for (var s in allSegments) {
            if (allSegments[s].length > 1) {
                var segmentRoutes = allSegments[s];
                var decode = google.maps.geometry.encoding.decodePath(segments[s]);

                for (var i = 0; i < segmentRoutes.length; i++) {
                    var thisRoute = segmentRoutes[i];

                    if (singleRoute && loadRoute.indexOf(thisRoute) === -1) {
                        continue;
                    }

                    var lineSymbol = {
                        path: 'M 0,-1 0,1',
                        strokeOpacity: 1,
                        scale: 4
                    };

                    var repeat = 10 * segmentRoutes.length;
                    var offset = (i * 10);
                    var line = new google.maps.Polyline({
                        path: decode,
                        strokeColor: '#' + routes[thisRoute].color,
                        strokeOpacity: 0,
                        icons: [{
                            icon: lineSymbol,
                            offset: offset + 'px',
                            repeat: repeat + 'px'
                        }],
                        strokeWeight: 4,
                        zIndex: 10,
                        clickable: false
                    });

                    lines.push(line);

                    line.setMap(map);
                }
            }
        }

        //creates the inidivdual stop markers
        for (var stop in stopIDs) {
            var stopRoutes = stopIDs[stop].routes;
            var stopColors = [];
            for (var i = 0; i < stopRoutes.length; i++) {
                if (singleRoute && loadRoute.indexOf(stopRoutes[i]) === -1) {
                    continue;
                }
                stopColors.push(routes[stopRoutes[i]].color); //used for creating stop symbol
            }
            if (stopColors.length == 0) {
                continue;
            }

            var marker = new google.maps.Marker({
                position: stopIDs[stop].location,
                map: map,
                title: stopIDs[stop].name,
                icon: "https://feeds.transloc.com/markers/stop.png?s=8&c=" + stopColors.join(),
                optimized: false,
                zIndex: 101
            });

            stopMarkers[stop] = marker;

            (function () {
                var thisStopID = stop;
                marker.addListener('click', function () {
                    infoWindow.close();

                    var stopRoutes = stopIDs[thisStopID].routes;

                    if(ga){
                        ga('send', 'event', 'Stop Info', 'open', stopIDs[thisStopID].name, thisStopID);
                    }

                    var $c = $(iwContent);
                    $c.find('.iw-stop-title').text(stopIDs[thisStopID].name);

                    var totInService = 0;
                    var totNotInService = 0;
                    for (var i = 0; i < stopRoutes.length; i++) {
                        if (inServiceRoutes.indexOf(stopRoutes[i]) !== -1) { //In Service
                            totInService++;
                            if (estimateStops.hasOwnProperty(thisStopID) && estimateStops[thisStopID].hasOwnProperty(stopRoutes[i]) && estimateStops[thisStopID][stopRoutes[i]].length > 0) { // In Service w/ estimates
                                var a = estimateStops[thisStopID][stopRoutes[i]]; //estimated arrivals
                                var estimateString = '';
                                for (var k = 0; k < 2 && k < a.length; k++) {
                                    if (k !== 0) {
                                        estimateString += ' & ';
                                    }
                                    var t = new Date(a[k].arrival_at);
                                    var n = new Date();
                                    var e = t.getTime() - n.getTime();
                                    var round = Math.floor(e / 1000 / 60);
                                    if (round === 0) {
                                        round = "<1";
                                    }
                                    estimateString += round + ' mins';
                                }
                                $c.find('.iw-in-service').find('.iw-route-' + stopRoutes[i]).show();
                                $c.find('.iw-in-service').find('.iw-route-' + stopRoutes[i]).find('.iw-estimate').text(estimateString);
                            } else { // In Service w/o estimates
                                $c.find('.iw-in-service').find('.iw-route-' + stopRoutes[i]).show();
                                $c.find('.iw-in-service').find('.iw-route-' + stopRoutes[i]).find('.iw-estimate').text('Estimate Currently Unavailable');
                            }
                        } else { // Not in Service
                            totNotInService++;
                            $c.find('.iw-not-in-service').find('.iw-route-' + stopRoutes[i]).show();
                        }


                    }
                    if (totInService === 0) { //no routes in service at this stop
                        $c.find('.iw-in-service').append('<div class="iw-route">No routes currently in service at this stop.</div>')
                    }

                    if (totNotInService === 0) {
                        $c.find('.iw-not-in-service').hide();
                    }

                    infoWindow.setContent($c[0].outerHTML);
                    infoWindow.open(map, stopMarkers[thisStopID]);
                })
            })();
        }


    }

    //Grabs the vehicle positions and updates the markers
    function loadMarker() {
        $.ajax({
            method: "GET",
            url: "https://transloc-api-1-2.p.rapidapi.com/vehicles.json",
            data: {"agencies": 1039, "routes": urlRoute},
            accepts: 'application/json',
            headers: {"X-Mashape-Key": "xXD7WqmWxTmshsrhgmekOfdKC3Omp1JwXRfjsnWfqYxf1pTcnd"}
        }).done(function (data) {

            inServiceRoutes = [];

            for (var i = 0; i < data.data[1039].length; i++) {
                var vehicle_id = data.data[1039][i].vehicle_id;
                var position = data.data[1039][i].location;
                var call_name = data.data[1039][i].call_name;
                var rotation = data.data[1039][i].heading;
                var route_id = data.data[1039][i].route_id;


                // HIDES ALL SUMMER ROUTES SO WE CAN USE THEM FOR OVERFLOW BUSSES
                //if(summerRoutes.indexOf(route_id) !== -1){
              //      continue;
               // }


                $('.ae-status-container').find('.line-' + route_id).find('.in-service').show();
                $('.ae-status-container').find('.line-' + route_id).find('.not-in-service').hide();
                inServiceRoutes.push(route_id);

                if (singleRoute && loadRoute.indexOf(route_id) === -1) {
                    continue;
                }

                var symbol = {
                    path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
                    anchor: new google.maps.Point(0, 2.6),
                    rotation: rotation,
                    fillColor: '#' + routes[route_id].color,
                    strokeColor: '#000000',
                    strokeWeight: 1,
                    fillOpacity: 1.0,
                    scale: 5
                };
                if (markers.hasOwnProperty(vehicle_id)) {
                    markers[vehicle_id].setIcon(symbol);
                    markers[vehicle_id].setPosition(position);
                } else {
                    markers[vehicle_id] = new SlidingMarker({
                        position: data.data[1039][i].location,
                        map: map,
                        title: data.data[1039][i].call_name,
                        //icon: "http://www.shuttle.uci.edu/gps/antexanteater.png",
                        icon: symbol,
                        duration: 2000,
                        easing: 'jswing',
                        optimized: false,
                        zIndex: 1
                    })
                }
            }
        });
    }

    //Grabs the stop time arrival estimates
    function loadEstimates(updateStatus) {
        $.ajax({
            method: "GET",
            url: "https://transloc-api-1-2.p.rapidapi.com/arrival-estimates.json",
            data: {"agencies": 1039},
            accepts: 'application/json',
            headers: {"X-Mashape-Key": "xXD7WqmWxTmshsrhgmekOfdKC3Omp1JwXRfjsnWfqYxf1pTcnd"}
        }).done(function (data) {
            var stops = data.data;
            var temp = {};
            for (var i = 0; i < stops.length; i++) {
                var arrivals = stops[i].arrivals;
                var stop_id = stops[i].stop_id;

                var routeArrivals = {};

                for (var j = 0; j < arrivals.length; j++) {
                    if (routeArrivals.hasOwnProperty(arrivals[j].route_id)) {
                        routeArrivals[arrivals[j].route_id].push(arrivals[j]);
                    } else {
                        routeArrivals[arrivals[j].route_id] = [arrivals[j]];
                    }
                }

                temp[stop_id] = routeArrivals;
            }
            estimateStops = temp;
        })
    }

    //Grabs announcements from the transloc RSS feed and initializes them
    function loadAnnouncements() {
        $.ajax({
            method: "GET",
            url: "/wp-content/themes/Avada-Child-Theme/ae-map/rss.php",
            accepts: 'application/rss+xml, application/rdf+xml;q=0.8, application/atom+xml;q=0.6, application/xml;q=0.4, text/xml;q=0.4'
        }).done(function (data) {
            var parsedXML = $.parseXML(data);
            var $xml = $(parsedXML);
            var a = $('#announcements');
            if ($xml.find('item').length > 0) {
                $xml.find('item').each(function (index) {
                    var thisDate = new Date($(this).find('pubDate').text());
                    var dateOutput = (thisDate.getMonth() + 1) + '/' + thisDate.getDate() + '/' + thisDate.getFullYear();
                    a.append("<div class='announcement-item'><div class='announcement-title'>" + $(this).find('title').text() + "</div><div class='announcement-date'>" + dateOutput + "</div><div class='announcement-content'>" + $(this).find('description').text() + "</div></div>");
                });
                setTimeout(function () {
                    a.show();
                }, 1500)
            } else {
                a.hide();
            }
        });

        $('#announcemnts-close').on('click', function () {
            $('#announcements').hide();
        });
    }

    initialize();
    loadMarker();
    setInterval(function () {
        loadMarker();
    }, 1000); //Vehicles loaded every second

    loadEstimates(true);
    setInterval(function () {
        loadEstimates();
    }, 6000); //arrival estimates loaded every 6 seconds

    loadAnnouncements();

};

//Loads the script
var alreadyrunflag = 0;

if (document.addEventListener)
    document.addEventListener("DOMContentLoaded", function () {
        alreadyrunflag = 1;
        VanillaRunOnDomReady();
    }, false);
else if (document.all && !window.opera) {
    document.write('<script type="text/javascript" id="contentloadtag" defer="defer" src="javascript:void(0)"><\/script>');
    var contentloadtag = document.getElementById("contentloadtag")
    contentloadtag.onreadystatechange = function () {
        if (this.readyState == "complete") {
            alreadyrunflag = 1;
            VanillaRunOnDomReady();
        }
    }
}

window.onload = function () {
    setTimeout("if (!alreadyrunflag){VanillaRunOnDomReady}", 0);
}